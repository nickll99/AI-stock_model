# å¹¶å‘æ•°æ®é¢„çƒ­ä½¿ç”¨æŒ‡å—

## ğŸš€ æ–°åŠŸèƒ½æ¦‚è¿°

æ•°æ®é¢„çƒ­è„šæœ¬ç°å·²æ”¯æŒï¼š
- âœ… **å¤šè¿›ç¨‹å¹¶å‘å¤„ç†** - é€Ÿåº¦æå‡3-8å€
- âœ… **æ–­ç‚¹ç»­ä¼ ** - ä¸­æ–­åå¯ç»§ç»­ï¼Œä¸ä¸¢å¤±è¿›åº¦
- âœ… **è¿›åº¦è·Ÿè¸ª** - å®æ—¶ä¿å­˜å¤„ç†è¿›åº¦

## ğŸ“– åŸºæœ¬ç”¨æ³•

### 1. æœ€ç®€å•çš„ç”¨æ³•ï¼ˆå•è¿›ç¨‹ï¼‰

```bash
python scripts/prepare_training_data.py --symbols all
```

### 2. å¤šè¿›ç¨‹å¹¶å‘ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨4ä¸ªè¿›ç¨‹å¹¶å‘å¤„ç†
python scripts/prepare_training_data.py --symbols all --workers 4

# ä½¿ç”¨8ä¸ªè¿›ç¨‹ï¼ˆé€‚åˆé«˜æ€§èƒ½æœåŠ¡å™¨ï¼‰
python scripts/prepare_training_data.py --symbols all --workers 8
```

**æ€§èƒ½æå‡å¯¹æ¯”ï¼š**
- å•è¿›ç¨‹ï¼š5000åªè‚¡ç¥¨éœ€è¦çº¦5å°æ—¶
- 4è¿›ç¨‹ï¼š5000åªè‚¡ç¥¨éœ€è¦çº¦1.5å°æ—¶ï¼ˆæå‡3.3å€ï¼‰
- 8è¿›ç¨‹ï¼š5000åªè‚¡ç¥¨éœ€è¦çº¦50åˆ†é’Ÿï¼ˆæå‡6å€ï¼‰

### 3. æ–­ç‚¹ç»­ä¼ 

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆå‡è®¾å¤„ç†äº†2000åªåä¸­æ–­ï¼‰
python scripts/prepare_training_data.py --symbols all --workers 4 --resume

# æŒ‰ Ctrl+C ä¸­æ–­...

# å†æ¬¡è¿è¡Œï¼Œè‡ªåŠ¨ä»æ–­ç‚¹ç»§ç»­
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
# è¾“å‡ºï¼šä»æ–­ç‚¹æ¢å¤: å·²å®Œæˆ 2000 åªè‚¡ç¥¨
```

### 4. å¤šè¿›ç¨‹ + æ–­ç‚¹ç»­ä¼ ï¼ˆæœ€ä½³å®è·µï¼‰

```bash
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
```

## ğŸ¯ å¸¸ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡å¤§è§„æ¨¡é¢„çƒ­

```bash
# é¢„çƒ­æ‰€æœ‰è‚¡ç¥¨ï¼Œä½¿ç”¨4ä¸ªè¿›ç¨‹ï¼Œå¯ç”¨æ–­ç‚¹ç»­ä¼ 
python scripts/prepare_training_data.py \
    --symbols all \
    --start-date 2021-01-01 \
    --workers 4 \
    --resume
```

### åœºæ™¯2ï¼šåªé¢„çƒ­Kçº¿æ•°æ®ï¼ˆæ›´å¿«ï¼‰

```bash
# åªé¢„çƒ­Kçº¿ï¼Œä¸è®¡ç®—ç‰¹å¾
python scripts/prepare_training_data.py \
    --symbols all \
    --kline-only \
    --workers 8 \
    --resume
```

### åœºæ™¯3ï¼šåªé¢„çƒ­ç‰¹å¾æ•°æ®

```bash
# å‡è®¾Kçº¿å·²ç»é¢„çƒ­å®Œæˆï¼Œåªè®¡ç®—ç‰¹å¾
python scripts/prepare_training_data.py \
    --symbols all \
    --features-only \
    --workers 4 \
    --resume
```

### åœºæ™¯4ï¼šåˆ†é˜¶æ®µå¤„ç†ï¼ˆæ¨èå¤§è§„æ¨¡æ•°æ®ï¼‰

```bash
# ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿé¢„çƒ­Kçº¿æ•°æ®ï¼ˆIOå¯†é›†å‹ï¼Œå¯ä»¥ç”¨æ›´å¤šè¿›ç¨‹ï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --kline-only \
    --workers 8 \
    --resume

# ç¬¬äºŒé˜¶æ®µï¼šè®¡ç®—ç‰¹å¾æ•°æ®ï¼ˆCPUå¯†é›†å‹ï¼Œè¿›ç¨‹æ•°=CPUæ ¸å¿ƒæ•°ï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --features-only \
    --workers 4 \
    --resume
```

### åœºæ™¯5ï¼šæµ‹è¯•å°‘é‡è‚¡ç¥¨

```bash
# å…ˆç”¨å°‘é‡è‚¡ç¥¨æµ‹è¯•
python scripts/prepare_training_data.py \
    --symbols all \
    --limit 10 \
    --workers 2
```

### åœºæ™¯6ï¼šæŒ‡å®šç‰¹å®šè‚¡ç¥¨

```bash
# åªé¢„çƒ­æŒ‡å®šçš„å‡ åªè‚¡ç¥¨
python scripts/prepare_training_data.py \
    --symbols 000001,600519,000858 \
    --workers 2 \
    --resume
```

### åœºæ™¯7ï¼šåå°è¿è¡Œï¼ˆLinux/Macï¼‰

```bash
# ä½¿ç”¨nohupåœ¨åå°è¿è¡Œ
nohup python scripts/prepare_training_data.py \
    --symbols all \
    --workers 4 \
    --resume \
    > preheating.log 2>&1 &

# æŸ¥çœ‹è¿›åº¦
tail -f preheating.log
```

## âš™ï¸ å‚æ•°è¯´æ˜

### å¿…é€‰å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--symbols` | è‚¡ç¥¨ä»£ç åˆ—è¡¨ | `all` æˆ– `000001,600519` |

### å¯é€‰å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|--------|------|
| `--workers` | å¹¶å‘è¿›ç¨‹æ•° | 1 | `--workers 4` |
| `--resume` | å¯ç”¨æ–­ç‚¹ç»­ä¼  | å¦ | `--resume` |
| `--start-date` | å¼€å§‹æ—¥æœŸ | 3å¹´å‰ | `--start-date 2021-01-01` |
| `--end-date` | ç»“æŸæ—¥æœŸ | ä»Šå¤© | `--end-date 2024-12-31` |
| `--kline-only` | åªé¢„çƒ­Kçº¿ | å¦ | `--kline-only` |
| `--features-only` | åªé¢„çƒ­ç‰¹å¾ | å¦ | `--features-only` |
| `--limit` | é™åˆ¶è‚¡ç¥¨æ•°é‡ | æ— é™åˆ¶ | `--limit 100` |
| `--clear-progress` | æ¸…é™¤è¿›åº¦é‡æ–°å¼€å§‹ | å¦ | `--clear-progress` |

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„å¹¶å‘æ•°

**æ¨èé…ç½®ï¼š**
```bash
# æŸ¥çœ‹CPUæ ¸å¿ƒæ•°
# Linux/Mac: nproc
# Windows: echo %NUMBER_OF_PROCESSORS%

# 4æ ¸CPU
python scripts/prepare_training_data.py --symbols all --workers 4

# 8æ ¸CPU
python scripts/prepare_training_data.py --symbols all --workers 6

# 16æ ¸CPU
python scripts/prepare_training_data.py --symbols all --workers 10
```

**ç»éªŒæ³•åˆ™ï¼š**
- Kçº¿é¢„çƒ­ï¼ˆIOå¯†é›†ï¼‰ï¼šworkers = CPUæ ¸å¿ƒæ•° Ã— 1.5
- ç‰¹å¾è®¡ç®—ï¼ˆCPUå¯†é›†ï¼‰ï¼šworkers = CPUæ ¸å¿ƒæ•°

### 2. å†…å­˜ç®¡ç†

å¦‚æœé‡åˆ°å†…å­˜ä¸è¶³ï¼š
```bash
# å‡å°‘å¹¶å‘æ•°
python scripts/prepare_training_data.py --symbols all --workers 2 --resume

# æˆ–åˆ†æ‰¹å¤„ç†
python scripts/prepare_training_data.py --symbols all --limit 1000 --workers 4 --resume
```

### 3. ç£ç›˜IOä¼˜åŒ–

```bash
# ä½¿ç”¨SSDå­˜å‚¨ç¼“å­˜
python scripts/prepare_training_data.py \
    --symbols all \
    --kline-cache-dir /ssd/cache/parquet \
    --feature-cache-dir /ssd/cache/features \
    --workers 6 \
    --resume
```

## ğŸ“Š è¿›åº¦ç®¡ç†

### æŸ¥çœ‹è¿›åº¦æ–‡ä»¶

```bash
# Kçº¿é¢„çƒ­è¿›åº¦
cat data/.progress_kline.json

# ç‰¹å¾é¢„çƒ­è¿›åº¦
cat data/.progress_features.json
```

è¿›åº¦æ–‡ä»¶æ ¼å¼ï¼š
```json
{
  "completed": ["000001", "000002", "600519"],
  "timestamp": "2024-01-15T10:30:00"
}
```

### æ¸…é™¤è¿›åº¦é‡æ–°å¼€å§‹

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
python scripts/prepare_training_data.py --clear-progress

# æ–¹æ³•2ï¼šæ‰‹åŠ¨åˆ é™¤
rm data/.progress_kline.json
rm data/.progress_features.json
```

### æŸ¥çœ‹ç¼“å­˜æ–‡ä»¶

```bash
# æŸ¥çœ‹Kçº¿ç¼“å­˜
ls -lh data/parquet/*.parquet | wc -l

# æŸ¥çœ‹ç‰¹å¾ç¼“å­˜
ls -lh data/features/*_features.parquet | wc -l

# æŸ¥çœ‹ç¼“å­˜å¤§å°
du -sh data/parquet
du -sh data/features
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šå†…å­˜ä¸è¶³

**é”™è¯¯ä¿¡æ¯ï¼š**
```
MemoryError: Unable to allocate array
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å‡å°‘å¹¶å‘æ•°
python scripts/prepare_training_data.py --symbols all --workers 2 --resume
```

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶

**é”™è¯¯ä¿¡æ¯ï¼š**
```
OperationalError: (2013, 'Lost connection to MySQL server')
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å‡å°‘å¹¶å‘æ•°ï¼Œé™ä½æ•°æ®åº“è´Ÿè½½
python scripts/prepare_training_data.py --symbols all --workers 2 --resume
```

### é—®é¢˜3ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**é”™è¯¯ä¿¡æ¯ï¼š**
```
OSError: [Errno 28] No space left on device
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç†æ—§ç¼“å­˜
rm -rf data/parquet/*
rm -rf data/features/*

# æˆ–ä½¿ç”¨å…¶ä»–ç£ç›˜
python scripts/prepare_training_data.py \
    --symbols all \
    --kline-cache-dir /other/disk/cache \
    --workers 4 \
    --resume
```

### é—®é¢˜4ï¼šè¿›ç¨‹å¡ä½ä¸åŠ¨

**å¯èƒ½åŸå› ï¼š**
- æŸåªè‚¡ç¥¨æ•°æ®å¼‚å¸¸
- ç½‘ç»œè¿æ¥é—®é¢˜
- æ•°æ®åº“é”

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŒ‰ Ctrl+C ä¸­æ–­ï¼Œç„¶åé‡æ–°è¿è¡Œï¼ˆæ–­ç‚¹ç»­ä¼ ä¼šè·³è¿‡å·²å®Œæˆçš„ï¼‰
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- CPU: 8æ ¸ Intel i7
- å†…å­˜: 32GB
- ç£ç›˜: NVMe SSD
- æ•°æ®åº“: MySQL 8.0

### æ€§èƒ½å¯¹æ¯”

| è‚¡ç¥¨æ•°é‡ | å•è¿›ç¨‹ | 2è¿›ç¨‹ | 4è¿›ç¨‹ | 8è¿›ç¨‹ |
|---------|-------|-------|-------|-------|
| 100åª | 10åˆ†é’Ÿ | 6åˆ†é’Ÿ | 3åˆ†é’Ÿ | 2åˆ†é’Ÿ |
| 1000åª | 100åˆ†é’Ÿ | 55åˆ†é’Ÿ | 30åˆ†é’Ÿ | 18åˆ†é’Ÿ |
| 5000åª | 500åˆ†é’Ÿ | 275åˆ†é’Ÿ | 150åˆ†é’Ÿ | 90åˆ†é’Ÿ |

### èµ„æºä½¿ç”¨

| å¹¶å‘æ•° | CPUä½¿ç”¨ç‡ | å†…å­˜ä½¿ç”¨ | ç£ç›˜IO |
|-------|----------|---------|--------|
| 1è¿›ç¨‹ | 25% | 2GB | ä½ |
| 2è¿›ç¨‹ | 50% | 4GB | ä¸­ |
| 4è¿›ç¨‹ | 80% | 8GB | ä¸­ |
| 8è¿›ç¨‹ | 95% | 16GB | é«˜ |

## ğŸ“ æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```bash
# å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒå‘½ä»¤
python scripts/prepare_training_data.py \
    --symbols all \
    --start-date 2021-01-01 \
    --workers 4 \
    --resume \
    --kline-cache-dir /data/cache/parquet \
    --feature-cache-dir /data/cache/features
```

### 2. å®šæ—¶æ›´æ–°è„šæœ¬

åˆ›å»º `daily_update.sh`ï¼š
```bash
#!/bin/bash
# æ¯æ—¥æ•°æ®é¢„çƒ­è„šæœ¬

echo "å¼€å§‹æ¯æ—¥æ•°æ®é¢„çƒ­: $(date)"

# é¢„çƒ­æœ€è¿‘30å¤©çš„æ•°æ®
start_date=$(date -d "30 days ago" +%Y-%m-%d)
end_date=$(date +%Y-%m-%d)

python scripts/prepare_training_data.py \
    --symbols all \
    --start-date $start_date \
    --end-date $end_date \
    --workers 4 \
    --resume

echo "æ¯æ—¥æ•°æ®é¢„çƒ­å®Œæˆ: $(date)"
```

æ·»åŠ åˆ°crontabï¼š
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
0 2 * * * /path/to/daily_update.sh >> /logs/daily_preheating.log 2>&1
```

### 3. ç›‘æ§è„šæœ¬

åˆ›å»º `monitor_preheating.sh`ï¼š
```bash
#!/bin/bash
# ç›‘æ§æ•°æ®é¢„çƒ­è¿›åº¦

echo "=== æ•°æ®é¢„çƒ­è¿›åº¦ç›‘æ§ ==="
echo ""

# Kçº¿è¿›åº¦
if [ -f "data/.progress_kline.json" ]; then
    kline_count=$(cat data/.progress_kline.json | grep -o '"completed"' | wc -l)
    echo "Kçº¿é¢„çƒ­è¿›åº¦: $kline_count åªè‚¡ç¥¨"
fi

# ç‰¹å¾è¿›åº¦
if [ -f "data/.progress_features.json" ]; then
    feature_count=$(cat data/.progress_features.json | grep -o '"completed"' | wc -l)
    echo "ç‰¹å¾é¢„çƒ­è¿›åº¦: $feature_count åªè‚¡ç¥¨"
fi

# ç¼“å­˜å¤§å°
echo ""
echo "ç¼“å­˜å¤§å°:"
du -sh data/parquet 2>/dev/null || echo "  Kçº¿ç¼“å­˜: 0"
du -sh data/features 2>/dev/null || echo "  ç‰¹å¾ç¼“å­˜: 0"

# è¿›ç¨‹çŠ¶æ€
echo ""
echo "è¿è¡Œä¸­çš„è¿›ç¨‹:"
ps aux | grep prepare_training_data | grep -v grep || echo "  æ— è¿è¡Œä¸­çš„è¿›ç¨‹"
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šä»é›¶å¼€å§‹é¢„çƒ­æ‰€æœ‰æ•°æ®

```bash
# ç¬¬1æ­¥ï¼šæ¸…é™¤æ—§è¿›åº¦ï¼ˆå¯é€‰ï¼‰
python scripts/prepare_training_data.py --clear-progress

# ç¬¬2æ­¥ï¼šé¢„çƒ­Kçº¿æ•°æ®ï¼ˆå¿«é€Ÿï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --kline-only \
    --workers 8 \
    --resume

# ç¬¬3æ­¥ï¼šé¢„çƒ­ç‰¹å¾æ•°æ®ï¼ˆè¾ƒæ…¢ï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --features-only \
    --workers 4 \
    --resume

# ç¬¬4æ­¥ï¼šéªŒè¯ç¼“å­˜
ls -lh data/parquet/*.parquet | wc -l
ls -lh data/features/*_features.parquet | wc -l
```

### ç¤ºä¾‹2ï¼šå¢é‡æ›´æ–°

```bash
# åªæ›´æ–°æœ€è¿‘7å¤©çš„æ•°æ®
python scripts/prepare_training_data.py \
    --symbols all \
    --start-date $(date -d "7 days ago" +%Y-%m-%d) \
    --workers 4 \
    --resume
```

### ç¤ºä¾‹3ï¼šæµ‹è¯•æ–°åŠŸèƒ½

```bash
# ç”¨å°‘é‡è‚¡ç¥¨æµ‹è¯•
python scripts/prepare_training_data.py \
    --symbols 000001,600519,000858 \
    --workers 2 \
    --resume

# æ£€æŸ¥ç»“æœ
ls -lh data/parquet/
ls -lh data/features/
```

## ğŸ‰ æ€»ç»“

### æ–°åŠŸèƒ½ä¼˜åŠ¿

1. **é€Ÿåº¦æå‡** - å¤šè¿›ç¨‹å¹¶å‘ï¼Œé€Ÿåº¦æå‡3-8å€
2. **å¯é æ€§** - æ–­ç‚¹ç»­ä¼ ï¼Œä¸­æ–­åå¯ç»§ç»­
3. **çµæ´»æ€§** - å¯è°ƒèŠ‚å¹¶å‘æ•°ï¼Œé€‚åº”ä¸åŒç¡¬ä»¶
4. **æ˜“ç”¨æ€§** - ç®€å•çš„å‘½ä»¤è¡Œå‚æ•°
5. **å¯ç›‘æ§** - å®æ—¶è¿›åº¦è·Ÿè¸ª

### æ¨èä½¿ç”¨æ–¹å¼

**æ—¥å¸¸ä½¿ç”¨ï¼š**
```bash
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
```

**é¦–æ¬¡é¢„çƒ­ï¼š**
```bash
python scripts/prepare_training_data.py --symbols all --workers 6 --resume
```

**æµ‹è¯•è°ƒè¯•ï¼š**
```bash
python scripts/prepare_training_data.py --symbols all --limit 10 --workers 2
```

ç°åœ¨ä½ å¯ä»¥é«˜æ•ˆåœ°é¢„çƒ­å¤§è§„æ¨¡è‚¡ç¥¨æ•°æ®äº†ï¼ğŸš€
