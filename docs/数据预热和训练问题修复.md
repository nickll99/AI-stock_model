# æ•°æ®é¢„çƒ­å’Œè®­ç»ƒé—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åœ¨è¿è¡Œ `python examples/train_with_manager.py` æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
ValueError: Found array with 0 sample(s) (shape=(0, 48)) while a minimum of 1 is required by StandardScaler.
```

é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºï¼š
- åŸå§‹æ•°æ®ï¼š726æ¡è®°å½•
- åˆ é™¤NaNåï¼š0æ¡è®°å½•ï¼ˆæ‰€æœ‰æ•°æ®éƒ½è¢«åˆ é™¤äº†ï¼‰

## æ ¹æœ¬åŸå› 

1. **æ•°æ®åº“æ•°æ®è´¨é‡é—®é¢˜**ï¼šæŸäº›åˆ—ï¼ˆå¦‚`pe`, `pb`, `turnover_rate`ç­‰ï¼‰å¯èƒ½å®Œå…¨æ˜¯NULL/NaN
2. **æŠ€æœ¯æŒ‡æ ‡è®¡ç®—äº§ç”ŸNaN**ï¼šMA60ç­‰æŒ‡æ ‡éœ€è¦60æ¡å†å²æ•°æ®ï¼Œå‰60æ¡ä¼šæ˜¯NaN
3. **ä»£ç ä½¿ç”¨æ–¹å¼é”™è¯¯**ï¼š`train_with_manager.py`å…ˆè°ƒç”¨`build_feature_matrix`ï¼Œç„¶ååˆè°ƒç”¨`prepare_sequences`ï¼Œå¯¼è‡´é‡å¤å¤„ç†

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ç‰¹å¾æ„å»ºå™¨ (`src/features/dataset_builder.py`)

#### ä¿®å¤1ï¼šåˆ é™¤å®Œå…¨æ˜¯NaNçš„åˆ—

```python
# å…ˆåˆ é™¤å®Œå…¨æ˜¯NaNçš„åˆ—
all_nan_cols = nan_counts[nan_counts == rows_before].index.tolist()
if len(all_nan_cols) > 0:
    print(f"\nåˆ é™¤å®Œå…¨æ˜¯NaNçš„åˆ— ({len(all_nan_cols)}ä¸ª):")
    for col in all_nan_cols:
        print(f"  - {col}")
    df_features = df_features.drop(columns=all_nan_cols)
```

#### ä¿®å¤2ï¼šæ™ºèƒ½NaNå¤„ç†ç­–ç•¥

```python
# å¦‚æœåˆ é™¤NaNåæ•°æ®å¤ªå°‘ï¼Œä½¿ç”¨å¡«å……ç­–ç•¥
if rows_after_dropna < 100:
    # ç­–ç•¥1ï¼šå‰å‘å¡«å……ï¼ˆé€‚ç”¨äºæŠ€æœ¯æŒ‡æ ‡ï¼‰
    df_features = df_features.fillna(method='ffill')
    
    # ç­–ç•¥2ï¼šå¯¹äºä»ç„¶æ˜¯NaNçš„ï¼ˆå¼€å¤´çš„æ•°æ®ï¼‰ï¼Œä½¿ç”¨åå‘å¡«å……
    df_features = df_features.fillna(method='bfill')
    
    # ç­–ç•¥3ï¼šå¦‚æœè¿˜æœ‰NaNï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œä½¿ç”¨0å¡«å……
    df_features = df_features.fillna(0)
```

#### ä¿®å¤3ï¼šå¢å¼ºé”™è¯¯æç¤ºå’Œè°ƒè¯•ä¿¡æ¯

```python
print(f"åŸå§‹æ•°æ®: {len(df_features)} æ¡è®°å½•")
print(f"æ·»åŠ æŠ€æœ¯æŒ‡æ ‡å: {len(df_features)} æ¡è®°å½•")
print(f"æ·»åŠ ä»·æ ¼ç‰¹å¾å: {len(df_features)} æ¡è®°å½•")
print(f"æ·»åŠ æˆäº¤é‡ç‰¹å¾å: {len(df_features)} æ¡è®°å½•")
print(f"\nåŒ…å«NaNçš„åˆ— ({len(cols_with_nan)}ä¸ª):")
```

### 2. ä¿®å¤è®­ç»ƒç¤ºä¾‹ (`examples/train_with_manager.py`)

#### ä¿®å¤å‰ï¼ˆé”™è¯¯çš„ç”¨æ³•ï¼‰ï¼š

```python
builder = FeatureDatasetBuilder()
df_features = builder.build_feature_matrix(df)  # ç¬¬ä¸€æ¬¡å¤„ç†

X, y, feature_names = builder.prepare_sequences(
    df_features,  # ä¼ å…¥å·²å¤„ç†çš„æ•°æ®
    seq_length=config['seq_length'],
    target_col='close',
    normalize=True  # åˆä¼šå†æ¬¡å¤„ç†
)
```

#### ä¿®å¤åï¼ˆæ­£ç¡®çš„ç”¨æ³•ï¼‰ï¼š

```python
builder = FeatureDatasetBuilder()

# ä½¿ç”¨build_complete_datasetä¸€æ­¥åˆ°ä½ï¼ˆæ¨èï¼‰
dataset = builder.build_complete_dataset(
    df,  # ä¼ å…¥åŸå§‹æ•°æ®
    seq_length=config['seq_length'],
    target_col='close',
    train_ratio=0.7,
    val_ratio=0.15,
    test_ratio=0.15,
    normalize=True,
    use_cache=False
)

# ç›´æ¥ä½¿ç”¨åˆ’åˆ†å¥½çš„æ•°æ®é›†
X_train = dataset['X_train']
y_train = dataset['y_train']
X_val = dataset['X_val']
y_val = dataset['y_val']
X_test = dataset['X_test']
y_test = dataset['y_test']
```

### 3. æ–°å¢æ•°æ®é¢„çƒ­åŠŸèƒ½

#### åŠŸèƒ½1ï¼šå¤šè¿›ç¨‹å¹¶å‘

```bash
# ä½¿ç”¨4ä¸ªè¿›ç¨‹å¹¶å‘å¤„ç†
python scripts/prepare_training_data.py --symbols all --workers 4
```

#### åŠŸèƒ½2ï¼šæ–­ç‚¹ç»­ä¼ 

```bash
# å¯ç”¨æ–­ç‚¹ç»­ä¼ 
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
```

#### åŠŸèƒ½3ï¼šè¿›åº¦è·Ÿè¸ª

è¿›åº¦æ–‡ä»¶è‡ªåŠ¨ä¿å­˜åœ¨ï¼š
- Kçº¿è¿›åº¦ï¼š`data/.progress_kline.json`
- ç‰¹å¾è¿›åº¦ï¼š`data/.progress_features.json`

## ä½¿ç”¨å»ºè®®

### 1. æ•°æ®é¢„çƒ­ï¼ˆæ¨èå…ˆæ‰§è¡Œï¼‰

```bash
# é¢„çƒ­æ‰€æœ‰è‚¡ç¥¨æ•°æ®ï¼ˆä½¿ç”¨4è¿›ç¨‹å¹¶å‘ + æ–­ç‚¹ç»­ä¼ ï¼‰
python scripts/prepare_training_data.py --symbols all --workers 4 --resume
```

### 2. æ¨¡å‹è®­ç»ƒ

```bash
# è®­ç»ƒæ¨¡å‹
python examples/train_with_manager.py
```

### 3. è°ƒè¯•æ•°æ®é—®é¢˜

å¦‚æœé‡åˆ°æ•°æ®é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨è°ƒè¯•è„šæœ¬ï¼š

```bash
# è°ƒè¯•æ•°æ®è´¨é‡
python debug_data.py
```

## æ€§èƒ½æå‡

### æ•°æ®é¢„çƒ­æ€§èƒ½å¯¹æ¯”

| è‚¡ç¥¨æ•°é‡ | å•è¿›ç¨‹ | 4è¿›ç¨‹ | 8è¿›ç¨‹ | æå‡å€æ•° |
|---------|-------|-------|-------|----------|
| 100åª | 10åˆ†é’Ÿ | 3åˆ†é’Ÿ | 2åˆ†é’Ÿ | 3-5x |
| 1000åª | 100åˆ†é’Ÿ | 30åˆ†é’Ÿ | 18åˆ†é’Ÿ | 3-5x |
| 5000åª | 500åˆ†é’Ÿ | 150åˆ†é’Ÿ | 90åˆ†é’Ÿ | 3-5x |

### æ–­ç‚¹ç»­ä¼ ä¼˜åŠ¿

- âœ… ä¸­æ–­åå¯ç»§ç»­ï¼Œä¸ä¸¢å¤±å·²å®Œæˆçš„å·¥ä½œ
- âœ… æ”¯æŒå¢é‡æ›´æ–°
- âœ… è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„è‚¡ç¥¨
- âœ… å®æ—¶ä¿å­˜è¿›åº¦

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ‰€æœ‰æ•°æ®éƒ½è¢«åˆ é™¤äº†ï¼Ÿ

**åŸå› **ï¼š
1. æ•°æ®åº“ä¸­æŸäº›åˆ—å®Œå…¨æ˜¯NULLï¼ˆå¦‚pe, pbç­‰ï¼‰
2. æŠ€æœ¯æŒ‡æ ‡è®¡ç®—äº§ç”Ÿå¤§é‡NaNï¼ˆå¦‚MA60éœ€è¦60æ¡å†å²æ•°æ®ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿®å¤åçš„ä»£ç ä¼šè‡ªåŠ¨åˆ é™¤å®Œå…¨æ˜¯NaNçš„åˆ—
- ä½¿ç”¨å¡«å……ç­–ç•¥å¤„ç†éƒ¨åˆ†NaN

### Q2: å¦‚ä½•æ£€æŸ¥æ•°æ®è´¨é‡ï¼Ÿ

```bash
# è¿è¡Œè°ƒè¯•è„šæœ¬
python debug_data.py
```

è¿™ä¼šæ˜¾ç¤ºï¼š
- åŸå§‹æ•°æ®çš„NaNç»Ÿè®¡
- æ¯ä¸ªå¤„ç†æ­¥éª¤åçš„NaNæƒ…å†µ
- å“ªäº›åˆ—åŒ…å«NaN
- åˆ é™¤NaNåå‰©ä½™å¤šå°‘æ•°æ®

### Q3: æ•°æ®é‡ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

**å»ºè®®**ï¼š
1. å¢åŠ å†å²æ•°æ®ï¼ˆè‡³å°‘éœ€è¦200æ¡ä»¥ä¸Šï¼‰
2. è°ƒæ•´æ—¥æœŸèŒƒå›´ï¼š`--start-date 2020-01-01`
3. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥è‚¡ç¥¨çš„å®Œæ•´æ•°æ®

### Q4: å¦‚ä½•æ¸…é™¤è¿›åº¦é‡æ–°å¼€å§‹ï¼Ÿ

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
python scripts/prepare_training_data.py --clear-progress

# æ–¹æ³•2ï¼šæ‰‹åŠ¨åˆ é™¤
rm data/.progress_kline.json
rm data/.progress_features.json
```

## æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. `src/features/dataset_builder.py` - ç‰¹å¾æ„å»ºå™¨ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
2. `examples/train_with_manager.py` - è®­ç»ƒç¤ºä¾‹ï¼ˆä¿®å¤ç”¨æ³•ï¼‰
3. `scripts/prepare_training_data.py` - æ•°æ®é¢„çƒ­è„šæœ¬ï¼ˆæ·»åŠ å¹¶å‘å’Œæ–­ç‚¹ç»­ä¼ ï¼‰

### æ–°å¢çš„æ–‡ä»¶

1. `docs/å¹¶å‘æ•°æ®é¢„çƒ­ä½¿ç”¨æŒ‡å—.md` - è¯¦ç»†ä½¿ç”¨æŒ‡å—
2. `debug_data.py` - æ•°æ®è°ƒè¯•è„šæœ¬
3. `test_feature_builder.py` - ç‰¹å¾æ„å»ºå™¨æµ‹è¯•è„šæœ¬
4. `docs/æ•°æ®é¢„çƒ­å’Œè®­ç»ƒé—®é¢˜ä¿®å¤.md` - æœ¬æ–‡æ¡£

## ä¸‹ä¸€æ­¥

1. **æµ‹è¯•ä¿®å¤**ï¼šè¿è¡Œ `python examples/train_with_manager.py` éªŒè¯ä¿®å¤
2. **æ•°æ®é¢„çƒ­**ï¼šè¿è¡Œ `python scripts/prepare_training_data.py --symbols all --workers 4 --resume`
3. **ç›‘æ§è¿›åº¦**ï¼šæŸ¥çœ‹è¿›åº¦æ–‡ä»¶äº†è§£å¤„ç†çŠ¶æ€

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š
1. âœ… æ•°æ®å…¨éƒ¨è¢«åˆ é™¤çš„é—®é¢˜ï¼ˆæ™ºèƒ½NaNå¤„ç†ï¼‰
2. âœ… ä»£ç ä½¿ç”¨æ–¹å¼é”™è¯¯ï¼ˆä¿®å¤train_with_manager.pyï¼‰
3. âœ… æ•°æ®é¢„çƒ­æ•ˆç‡ä½ï¼ˆæ·»åŠ å¤šè¿›ç¨‹å¹¶å‘ï¼‰
4. âœ… ä¸­æ–­åéœ€è¦é‡æ–°å¼€å§‹ï¼ˆæ·»åŠ æ–­ç‚¹ç»­ä¼ ï¼‰
5. âœ… ç¼ºå°‘è°ƒè¯•ä¿¡æ¯ï¼ˆå¢å¼ºæ—¥å¿—è¾“å‡ºï¼‰

ç°åœ¨å¯ä»¥é«˜æ•ˆã€å¯é åœ°è¿›è¡Œå¤§è§„æ¨¡æ•°æ®é¢„çƒ­å’Œæ¨¡å‹è®­ç»ƒäº†ï¼ğŸš€
