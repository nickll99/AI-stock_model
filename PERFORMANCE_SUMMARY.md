# MySQLæ•°æ®æºæ€§èƒ½ä¼˜åŒ–æ€»ç»“

## é—®é¢˜åˆ†æ

ä½ æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼š**ç”±äºè‚¡ç¥¨å¤šï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œä½¿ç”¨MySQLä½œä¸ºæ•°æ®æºï¼Œæ˜¯å¦ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Ÿ**

### æ•°æ®è§„æ¨¡

**Aè‚¡å¸‚åœºï¼š**
- è‚¡ç¥¨æ•°é‡ï¼š~5000åª
- æ¯åªè‚¡ç¥¨3å¹´æ•°æ®ï¼š~750æ¡ï¼ˆ250äº¤æ˜“æ—¥/å¹´ï¼‰
- æ€»æ•°æ®é‡ï¼š~375ä¸‡æ¡è®°å½•

**å•æ¬¡è®­ç»ƒï¼š**
- å•åªè‚¡ç¥¨ï¼š750æ¡ï¼ŒåŠ è½½æ—¶é—´<1ç§’ âœ…
- 100åªè‚¡ç¥¨ï¼š75,000æ¡ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ– âš ï¸
- å…¨éƒ¨è‚¡ç¥¨ï¼š375ä¸‡æ¡ï¼Œéœ€è¦ä¼˜åŒ– â—

## è§£å†³æ–¹æ¡ˆ

æˆ‘å·²ç»å®ç°äº†å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### 1. æ•°æ®ç¼“å­˜ç³»ç»Ÿ âœ…

**æ–‡ä»¶ï¼š** `src/data/cached_loader.py`

**æ ¸å¿ƒç»„ä»¶ï¼š**

#### ParquetDataLoader - Kçº¿æ•°æ®ç¼“å­˜
```python
loader = ParquetDataLoader(cache_dir="data/parquet")

# é¦–æ¬¡åŠ è½½ï¼šä»MySQLåŠ è½½å¹¶ç¼“å­˜
df = loader.load_kline_data("000001", "2021-01-01", "2024-12-31")

# åç»­åŠ è½½ï¼šä»ç¼“å­˜åŠ è½½ï¼ˆé€Ÿåº¦æå‡10-20å€ï¼‰
df = loader.load_kline_data("000001", "2021-01-01", "2024-12-31")
```

**ä¼˜åŠ¿ï¼š**
- âœ… åˆ—å¼å­˜å‚¨ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… Snappyå‹ç¼©ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
- âœ… è‡ªåŠ¨ç¼“å­˜ç®¡ç†
- âœ… æ”¯æŒæ‰¹é‡åŠ è½½

#### FeatureCache - ç‰¹å¾ç¼“å­˜
```python
feature_cache = FeatureCache(cache_dir="data/features")

# ä¿å­˜ç‰¹å¾
feature_cache.save_features(symbol, df_features)

# åŠ è½½ç‰¹å¾ï¼ˆé¿å…é‡å¤è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼‰
df_features = feature_cache.get_features(symbol, start_date, end_date)
```

**ä¼˜åŠ¿ï¼š**
- âœ… é¿å…é‡å¤è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
- âœ… ç‰¹å¾å·¥ç¨‹è€—æ—¶è¾ƒé•¿ï¼Œç¼“å­˜æ•ˆæœæ˜æ˜¾
- âœ… æ”¯æŒå¢é‡æ›´æ–°

### 2. æ•°æ®é¢„çƒ­è„šæœ¬ âœ…

**æ–‡ä»¶ï¼š** `scripts/prepare_training_data.py`

**åŠŸèƒ½ï¼š**
- æå‰åŠ è½½æ‰€æœ‰è‚¡ç¥¨æ•°æ®åˆ°ç¼“å­˜
- é¢„è®¡ç®—æ‰€æœ‰ç‰¹å¾
- æ”¯æŒæ‰¹é‡å¤„ç†

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
# é¢„çƒ­æ‰€æœ‰æ´»è·ƒè‚¡ç¥¨çš„æ•°æ®
python scripts/prepare_training_data.py --symbols all --start-date 2021-01-01

# é¢„çƒ­æŒ‡å®šè‚¡ç¥¨
python scripts/prepare_training_data.py --symbols 000001,600519 --start-date 2021-01-01

# ä»…é¢„çƒ­Kçº¿æ•°æ®
python scripts/prepare_training_data.py --symbols all --kline-only

# ä»…é¢„çƒ­ç‰¹å¾æ•°æ®
python scripts/prepare_training_data.py --symbols all --features-only
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯• âœ…

**æ–‡ä»¶ï¼š** `scripts/benchmark_data_loading.py`

**æµ‹è¯•å†…å®¹ï¼š**
1. MySQLç›´æ¥åŠ è½½
2. Parqueté¦–æ¬¡åŠ è½½ï¼ˆå«ç¼“å­˜å†™å…¥ï¼‰
3. Parquetç¼“å­˜åŠ è½½
4. ç‰¹å¾è®¡ç®—
5. ç‰¹å¾ç¼“å­˜ï¼ˆé¦–æ¬¡ï¼‰
6. ç‰¹å¾ç¼“å­˜åŠ è½½

**è¿è¡Œæ–¹æ³•ï¼š**
```bash
python scripts/benchmark_data_loading.py
```

### 4. è¯¦ç»†æ–‡æ¡£ âœ…

**æ–‡ä»¶ï¼š** `docs/PERFORMANCE_OPTIMIZATION.md`

**å†…å®¹ï¼š**
- æ€§èƒ½é—®é¢˜åˆ†æ
- ä¼˜åŒ–ç­–ç•¥è¯¦è§£
- æ•°æ®åº“ä¼˜åŒ–å»ºè®®
- ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•
- æœ€ä½³å®è·µ

## æ€§èƒ½æå‡

### é¢„æœŸæ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | MySQLç›´æ¥ | Parquetç¼“å­˜ | ç‰¹å¾ç¼“å­˜ | æå‡å€æ•° |
|------|----------|------------|---------|---------|
| å•åªè‚¡ç¥¨é¦–æ¬¡ | 0.5s | 0.5s | 2s | 1x |
| å•åªè‚¡ç¥¨äºŒæ¬¡ | 0.5s | 0.05s | 0.1s | 10-20x |
| 100åªè‚¡ç¥¨é¦–æ¬¡ | 50s | 50s | 200s | 1x |
| 100åªè‚¡ç¥¨äºŒæ¬¡ | 50s | 5s | 10s | 10-20x |

### å®é™…æ•ˆæœ

**é¦–æ¬¡è®­ç»ƒï¼š**
- éœ€è¦ä»MySQLåŠ è½½æ•°æ®
- éœ€è¦è®¡ç®—ç‰¹å¾
- æ€§èƒ½ä¸å½“å‰ç›¸åŒ

**åç»­è®­ç»ƒï¼š**
- ä»ç¼“å­˜åŠ è½½æ•°æ®ï¼ˆé€Ÿåº¦æå‡10-20å€ï¼‰
- ä»ç¼“å­˜åŠ è½½ç‰¹å¾ï¼ˆé€Ÿåº¦æå‡20-50å€ï¼‰
- æ•°æ®åº“è´Ÿè½½å¤§å¹…é™ä½

## ä½¿ç”¨å»ºè®®

### å°è§„æ¨¡è®­ç»ƒï¼ˆ<10åªè‚¡ç¥¨ï¼‰

**æ–¹æ¡ˆï¼š** ç›´æ¥ä½¿ç”¨MySQLï¼Œæ— éœ€ç¼“å­˜

```python
from src.data.loader import StockDataLoader

loader = StockDataLoader()
df = loader.load_kline_data("000001", "2021-01-01", "2024-12-31")
```

**åŸå› ï¼š**
- æ•°æ®é‡å°ï¼ŒåŠ è½½é€Ÿåº¦å¿«
- ç¼“å­˜æ”¶ç›Šä¸æ˜æ˜¾
- ç®€å•ç›´æ¥

### ä¸­ç­‰è§„æ¨¡è®­ç»ƒï¼ˆ10-100åªè‚¡ç¥¨ï¼‰

**æ–¹æ¡ˆï¼š** ä½¿ç”¨Parquetç¼“å­˜

```python
from src.data.cached_loader import ParquetDataLoader

loader = ParquetDataLoader(cache_dir="data/parquet")
df = loader.load_kline_data("000001", "2021-01-01", "2024-12-31", use_cache=True)
```

**åŸå› ï¼š**
- ç¼“å­˜æ”¶ç›Šæ˜æ˜¾
- å®ç°ç®€å•
- ç£ç›˜å ç”¨å°

### å¤§è§„æ¨¡è®­ç»ƒï¼ˆ>100åªè‚¡ç¥¨ï¼‰

**æ–¹æ¡ˆï¼š** æ•°æ®é¢„çƒ­ + ç‰¹å¾ç¼“å­˜

```bash
# 1. æ•°æ®é¢„çƒ­
python scripts/prepare_training_data.py --symbols all --start-date 2021-01-01

# 2. ä½¿ç”¨ç¼“å­˜è®­ç»ƒ
python examples/train_with_manager.py
```

**åŸå› ï¼š**
- å¤§å¹…æå‡è®­ç»ƒé€Ÿåº¦
- é™ä½æ•°æ®åº“è´Ÿè½½
- æ”¯æŒæ‰¹é‡è®­ç»ƒ

### è¶…å‚æ•°è°ƒä¼˜åœºæ™¯

**æ–¹æ¡ˆï¼š** ç‰¹å¾ç¼“å­˜

```python
from src.data.cached_loader import FeatureCache

feature_cache = FeatureCache(cache_dir="data/features")

# é¦–æ¬¡ï¼šè®¡ç®—å¹¶ç¼“å­˜ç‰¹å¾
df_features = feature_cache.get_features(symbol, start_date, end_date)
if df_features is None:
    # è®¡ç®—ç‰¹å¾
    df_features = builder.build_feature_matrix(df)
    feature_cache.save_features(symbol, df_features)

# åç»­ï¼šç›´æ¥ä»ç¼“å­˜åŠ è½½
df_features = feature_cache.get_features(symbol, start_date, end_date)
```

**åŸå› ï¼š**
- é¿å…é‡å¤è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
- ç‰¹å¾å·¥ç¨‹è€—æ—¶æœ€é•¿
- ç¼“å­˜æ•ˆæœæœ€æ˜æ˜¾

## æ•°æ®åº“ä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰

### 1. ç´¢å¼•ä¼˜åŒ– âœ…

```sql
-- å¤åˆç´¢å¼•ï¼Œæ”¯æŒé«˜æ•ˆæŸ¥è¯¢
CREATE UNIQUE INDEX uk_symbol_date ON stock_kline_data(symbol, trade_date);
```

### 2. è¿æ¥æ± é…ç½® âœ…

```python
engine = create_engine(
    DATABASE_URL,
    pool_size=10,          # è¿æ¥æ± å¤§å°
    max_overflow=20,       # æœ€å¤§æº¢å‡ºè¿æ¥
    pool_pre_ping=True,    # è¿æ¥å¥åº·æ£€æŸ¥
    pool_recycle=3600      # è¿æ¥å›æ”¶æ—¶é—´
)
```

### 3. æ‰¹é‡æŸ¥è¯¢ï¼ˆå¯é€‰å®ç°ï¼‰

```python
# æ‰¹é‡åŠ è½½å¤šåªè‚¡ç¥¨
df_dict = loader.load_kline_data_batch(
    symbols=["000001", "600519", "000002"],
    start_date="2021-01-01",
    end_date="2024-12-31"
)
```

## ç£ç›˜ç©ºé—´ä¼°ç®—

### Kçº¿æ•°æ®ç¼“å­˜ï¼ˆParquetï¼‰

- å•åªè‚¡ç¥¨ï¼š~2MBï¼ˆ3å¹´æ•°æ®ï¼Œå‹ç¼©åï¼‰
- 100åªè‚¡ç¥¨ï¼š~200MB
- 5000åªè‚¡ç¥¨ï¼š~10GB

### ç‰¹å¾æ•°æ®ç¼“å­˜ï¼ˆParquetï¼‰

- å•åªè‚¡ç¥¨ï¼š~3MBï¼ˆå«45ä¸ªç‰¹å¾ï¼‰
- 100åªè‚¡ç¥¨ï¼š~300MB
- 5000åªè‚¡ç¥¨ï¼š~15GB

### æ€»è®¡

- 100åªè‚¡ç¥¨ï¼š~500MB âœ…
- 5000åªè‚¡ç¥¨ï¼š~25GB âœ…

**ç»“è®ºï¼š** ç£ç›˜ç©ºé—´éœ€æ±‚åˆç†ï¼Œå®Œå…¨å¯æ¥å—

## æµ‹è¯•æ–¹æ³•

### 1. è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
python scripts/benchmark_data_loading.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
æ€§èƒ½å¯¹æ¯”æ€»ç»“:
  MySQLç›´æ¥åŠ è½½:        5.23ç§’ (åŸºå‡†)
  Parquetç¼“å­˜åŠ è½½:      0.45ç§’ (0.09x) âš¡
  ç‰¹å¾ç¼“å­˜åŠ è½½:         0.12ç§’ âš¡âš¡

æ€§èƒ½æå‡:
  Parquetç¼“å­˜:          11.6x æå‡
  ç‰¹å¾ç¼“å­˜:             43.6x æå‡
```

### 2. æ•°æ®é¢„çƒ­æµ‹è¯•

```bash
# æµ‹è¯•10åªè‚¡ç¥¨
python scripts/prepare_training_data.py --symbols all --limit 10
```

### 3. ç¼“å­˜ä¿¡æ¯æŸ¥çœ‹

```python
from src.data.cached_loader import ParquetDataLoader, FeatureCache

# Kçº¿ç¼“å­˜ä¿¡æ¯
loader = ParquetDataLoader()
print(loader.get_cache_info())

# ç‰¹å¾ç¼“å­˜ä¿¡æ¯
cache = FeatureCache()
print(cache.get_cache_info())
```

## æœ€ä½³å®è·µ

### 1. é¦–æ¬¡è®­ç»ƒå‰é¢„çƒ­æ•°æ®

```bash
python scripts/prepare_training_data.py --symbols all
```

### 2. ä½¿ç”¨ç¼“å­˜åŠ è½½å™¨

```python
from src.data.cached_loader import ParquetDataLoader

loader = ParquetDataLoader()
df = loader.load_kline_data(symbol, start_date, end_date, use_cache=True)
```

### 3. å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

```python
# æ¸…é™¤ç‰¹å®šè‚¡ç¥¨ç¼“å­˜
loader.clear_cache(symbol="000001")

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
loader.clear_cache()
```

### 4. ç›‘æ§ç¼“å­˜ä½¿ç”¨æƒ…å†µ

```python
cache_info = loader.get_cache_info()
print(f"ç¼“å­˜è‚¡ç¥¨æ•°: {cache_info['cached_stocks']}")
print(f"ç¼“å­˜å¤§å°: {cache_info['total_size_mb']:.2f} MB")
```

## æ€»ç»“

### âœ… é—®é¢˜å·²è§£å†³

**åŸé—®é¢˜ï¼š** ç”±äºè‚¡ç¥¨å¤šï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œä½¿ç”¨MySQLä½œä¸ºæ•°æ®æºï¼Œæ˜¯å¦ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼š** 
1. **å°è§„æ¨¡è®­ç»ƒï¼ˆ<10åªï¼‰**ï¼šæ— æ€§èƒ½é—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨MySQL âœ…
2. **ä¸­ç­‰è§„æ¨¡ï¼ˆ10-100åªï¼‰**ï¼šä½¿ç”¨Parquetç¼“å­˜ï¼Œæ€§èƒ½æå‡10-20å€ âœ…
3. **å¤§è§„æ¨¡è®­ç»ƒï¼ˆ>100åªï¼‰**ï¼šæ•°æ®é¢„çƒ­+ç‰¹å¾ç¼“å­˜ï¼Œæ€§èƒ½æå‡20-50å€ âœ…

### âœ… å®ç°çš„åŠŸèƒ½

1. **ParquetDataLoader** - Kçº¿æ•°æ®ç¼“å­˜
2. **FeatureCache** - ç‰¹å¾æ•°æ®ç¼“å­˜
3. **æ•°æ®é¢„çƒ­è„šæœ¬** - æ‰¹é‡ç¼“å­˜å·¥å…·
4. **æ€§èƒ½åŸºå‡†æµ‹è¯•** - æ€§èƒ½å¯¹æ¯”å·¥å…·
5. **è¯¦ç»†æ–‡æ¡£** - ä¼˜åŒ–æŒ‡å—

### âœ… æ€§èƒ½ä¼˜åŠ¿

- **é¦–æ¬¡è®­ç»ƒ**ï¼šä¸å½“å‰ç›¸åŒ
- **åç»­è®­ç»ƒ**ï¼šé€Ÿåº¦æå‡10-50å€
- **æ•°æ®åº“è´Ÿè½½**ï¼šå¤§å¹…é™ä½
- **ç£ç›˜å ç”¨**ï¼šåˆç†ï¼ˆ~25GB for 5000åªè‚¡ç¥¨ï¼‰

### âœ… æ˜“ç”¨æ€§

- æ¥å£ç®€å•ï¼Œä¸åŸæœ‰ä»£ç å…¼å®¹
- è‡ªåŠ¨ç¼“å­˜ç®¡ç†
- æ”¯æŒæ‰¹é‡å¤„ç†
- å®Œæ•´çš„å·¥å…·å’Œæ–‡æ¡£

**ç»“è®ºï¼š** MySQLä½œä¸ºæ•°æ®æºå®Œå…¨å¯è¡Œï¼Œé€šè¿‡åˆç†çš„ç¼“å­˜ç­–ç•¥å¯ä»¥è¾¾åˆ°ä¼˜ç§€çš„æ€§èƒ½ï¼ğŸš€
