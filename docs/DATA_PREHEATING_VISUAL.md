# 数据预热可视化流程

## 传统方式 vs 数据预热

### 传统方式（每次从MySQL加载）

```
训练流程（重复N次）:

┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ MySQL   │────>│ 网络IO  │────>│ 计算特征│────>│ 训练模型│
│ 查询    │     │ 传输    │     │ (慢)    │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
   慢(0.5s)        慢(0.2s)        很慢(2s)         快

总耗时: 2.7秒 × N次 = 很慢！
```

### 数据预热方式

```
预热阶段（一次性）:

┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ MySQL   │────>│ 网络IO  │────>│ 计算特征│────>│ 本地缓存│
│ 查询    │     │ 传输    │     │         │     │ (Parquet)│
└─────────┘     └─────────┘     └─────────┘     └─────────┘
   慢(0.5s)        慢(0.2s)        很慢(2s)         

训练流程（重复N次）:

┌─────────┐     ┌─────────┐
│ 本地缓存│────>│ 训练模型│
│ 读取    │     │         │
└─────────┘     └─────────┘
   快(0.1s)         快

总耗时: 2.7秒(预热) + 0.1秒 × N次 = 快！
```

## 详细流程图

```
数据预热完整流程:

第一步：K线数据预热
┌──────────────────────────────────────────────────────┐
│                    MySQL数据库                        │
│  ┌────────────────────────────────────────────┐     │
│  │ stock_kline_data 表                        │     │
│  │ - 000001: 750条 (open,high,low,close,vol) │     │
│  │ - 600519: 750条                            │     │
│  │ - 000002: 750条                            │     │
│  │ - ... (5000只股票)                         │     │
│  └────────────────────────────────────────────┘     │
└──────────────────────┬───────────────────────────────┘
                       │ SQL查询
                       │ SELECT * FROM stock_kline_data
                       │ WHERE symbol='000001'
                       │ AND trade_date BETWEEN ...
                       ▼
              ┌─────────────────┐
              │  Python内存     │
              │  DataFrame      │
              └────────┬────────┘
                       │ to_parquet()
                       │ compression='snappy'
                       ▼
┌──────────────────────────────────────────────────────┐
│              本地磁盘缓存 (data/parquet/)             │
│  ┌────────────────────────────────────────────┐     │
│  │ 000001.parquet (2MB, 压缩后)               │     │
│  │ 600519.parquet (2MB)                       │     │
│  │ 000002.parquet (2MB)                       │     │
│  │ ... (5000个文件, 总计~10GB)                │     │
│  └────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────┘

第二步：特征数据预热
┌──────────────────────────────────────────────────────┐
│         本地磁盘缓存 (data/parquet/)                  │
│         000001.parquet                                │
└──────────────────────┬───────────────────────────────┘
                       │ read_parquet()
                       ▼
              ┌─────────────────┐
              │  Python内存     │
              │  DataFrame      │
              │  (原始数据)     │
              └────────┬────────┘
                       │
                       │ 特征工程
                       │ ├─ calculate_ma()
                       │ ├─ calculate_macd()
                       │ ├─ calculate_rsi()
                       │ ├─ calculate_bollinger()
                       │ └─ ... (45个特征)
                       ▼
              ┌─────────────────┐
              │  Python内存     │
              │  DataFrame      │
              │  (含45个特征)   │
              └────────┬────────┘
                       │ to_parquet()
                       ▼
┌──────────────────────────────────────────────────────┐
│           本地磁盘缓存 (data/features/)               │
│  ┌────────────────────────────────────────────┐     │
│  │ 000001_features.parquet (3MB)              │     │
│  │ 600519_features.parquet (3MB)              │     │
│  │ 000002_features.parquet (3MB)              │     │
│  │ ... (5000个文件, 总计~15GB)                │     │
│  └────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────┘

第三步：训练时使用缓存
┌──────────────────────────────────────────────────────┐
│           本地磁盘缓存 (data/features/)               │
│           000001_features.parquet                     │
└──────────────────────┬───────────────────────────────┘
                       │ read_parquet() - 快！
                       ▼
              ┌─────────────────┐
              │  Python内存     │
              │  DataFrame      │
              │  (45个特征)     │
              └────────┬────────┘
                       │
                       │ prepare_sequences()
                       │ normalize()
                       ▼
              ┌─────────────────┐
              │  训练数据       │
              │  X: (N,60,45)   │
              │  y: (N,)        │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │  模型训练       │
              │  LSTM/GRU/...   │
              └─────────────────┘
```

## 性能对比可视化

```
加载时间对比（10只股票）:

MySQL直接加载:
████████████████████████ 24秒

Parquet缓存:
██ 1.2秒

提升: 20倍 ⚡⚡

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

批量训练100只股票:

MySQL直接加载:
████████████████████████████████████████ 240秒 (4分钟)

Parquet缓存:
██ 12秒

提升: 20倍 ⚡⚡

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

批量训练5000只股票:

MySQL直接加载:
████████████████████████████████████████ 12,000秒 (3.3小时)

Parquet缓存:
██ 600秒 (10分钟)

提升: 20倍 ⚡⚡
```

## 磁盘空间占用

```
缓存大小估算:

单只股票:
├─ K线缓存:    2MB
└─ 特征缓存:   3MB
   总计:       5MB

100只股票:
├─ K线缓存:    200MB
└─ 特征缓存:   300MB
   总计:       500MB ✅

5000只股票:
├─ K线缓存:    10GB
└─ 特征缓存:   15GB
   总计:       25GB ✅
```

## 使用流程

```
完整使用流程:

1. 首次使用 - 数据预热
   ┌─────────────────────────────────────┐
   │ python scripts/                     │
   │   prepare_training_data.py          │
   │   --symbols all                     │
   │   --start-date 2021-01-01           │
   └─────────────────────────────────────┘
                    │
                    ▼
   ┌─────────────────────────────────────┐
   │ 预热完成！                          │
   │ - K线缓存: 10GB                     │
   │ - 特征缓存: 15GB                    │
   │ - 总耗时: ~2小时（一次性）          │
   └─────────────────────────────────────┘

2. 训练模型 - 使用缓存
   ┌─────────────────────────────────────┐
   │ from src.data.cached_loader import  │
   │     ParquetDataLoader, FeatureCache │
   │                                     │
   │ loader = ParquetDataLoader()        │
   │ df = loader.load_kline_data(...)    │
   │ # 从缓存加载，速度快20倍！          │
   └─────────────────────────────────────┘

3. 定期更新 - 增量预热
   ┌─────────────────────────────────────┐
   │ # 每天收盘后更新                    │
   │ python scripts/                     │
   │   prepare_training_data.py          │
   │   --symbols all                     │
   │ # 只更新新数据，速度快              │
   └─────────────────────────────────────┘
```
