# ç‰¹å¾ç¼“å­˜é—®é¢˜æ’æŸ¥

## é—®é¢˜æè¿°

è¿è¡Œæ•°æ®é¢„çƒ­åï¼Œæ˜¾ç¤ºï¼š
```
ç‰¹å¾æ•°æ®é¢„çƒ­å®Œæˆ
  æˆåŠŸ: 3043
  å¤±è´¥: 0
  ç¼“å­˜å¤§å°: 0.00 MB  â† ä¸ºä»€ä¹ˆæ˜¯0ï¼Ÿ
```

---

## ğŸ” å¯èƒ½çš„åŸå› 

### åŸå› 1ï¼šç‰¹å¾æ•°æ®ä¸ºç©º

**ç—‡çŠ¶ï¼š**
- æˆåŠŸæ•°é‡>0
- ä½†ç¼“å­˜å¤§å°=0

**åŸå› ï¼š**
- `build_feature_matrix`è¿”å›çš„DataFrameä¸ºç©º
- `save_features`æ–¹æ³•æ£€æŸ¥åˆ°ç©ºæ•°æ®ï¼Œä¸ä¿å­˜

**è§£å†³æ–¹æ¡ˆï¼š**
æ£€æŸ¥ç‰¹å¾æ„å»ºè¿‡ç¨‹ä¸­çš„æ—¥å¿—ï¼Œçœ‹æ˜¯å¦æœ‰é”™è¯¯ã€‚

### åŸå› 2ï¼šç¼“å­˜ç›®å½•ä¸å­˜åœ¨æˆ–æƒé™é—®é¢˜

**ç—‡çŠ¶ï¼š**
- ä¿å­˜æ—¶æ²¡æœ‰æŠ¥é”™
- ä½†æ–‡ä»¶æ²¡æœ‰åˆ›å»º

**æ£€æŸ¥ï¼š**
```bash
# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
ls -ld data/features/

# æ£€æŸ¥æƒé™
ls -l data/

# æ‰‹åŠ¨åˆ›å»ºç›®å½•
mkdir -p data/features
chmod 755 data/features
```

### åŸå› 3ï¼š`get_cache_info`æ–¹æ³•æœ‰é—®é¢˜

**ç—‡çŠ¶ï¼š**
- æ–‡ä»¶å·²åˆ›å»º
- ä½†`get_cache_info`è¿”å›0

**æ£€æŸ¥ï¼š**
```bash
# æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶
ls data/features/*.parquet | wc -l
du -sh data/features/
```

---

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```bash
# æ£€æŸ¥ç‰¹å¾ç¼“å­˜æ–‡ä»¶æ•°é‡
ls data/features/*_features.parquet | wc -l

# æŸ¥çœ‹å‰10ä¸ªæ–‡ä»¶
ls data/features/*.parquet | head -10

# æŸ¥çœ‹ç¼“å­˜å¤§å°
du -sh data/features/
```

**é¢„æœŸç»“æœï¼š**
```
3043  # æ–‡ä»¶æ•°é‡
data/features/000001_features.parquet
data/features/000002_features.parquet
...
1.2G  data/features/  # ç¼“å­˜å¤§å°
```

### æ­¥éª¤2ï¼šæµ‹è¯•å•ä¸ªè‚¡ç¥¨çš„ç¼“å­˜

```bash
python test_feature_cache.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
======================================================================
  æµ‹è¯•ç‰¹å¾ç¼“å­˜åŠŸèƒ½
======================================================================

1. åŠ è½½Kçº¿æ•°æ®: 000001
âœ“ Kçº¿æ•°æ®: 726 æ¡

2. æ„å»ºç‰¹å¾...
åŸå§‹æ•°æ®: 726 æ¡è®°å½•
...
âœ“ ç‰¹å¾æ•°æ®: 451 æ¡, 41 åˆ—

3. ä¿å­˜ç‰¹å¾ç¼“å­˜...
âœ“ ç¼“å­˜æ–‡ä»¶å·²åˆ›å»º: data/features/000001_features.parquet
âœ“ æ–‡ä»¶å¤§å°: 0.15 MB

4. åŠ è½½ç‰¹å¾ç¼“å­˜...
âœ“ ä»ç¼“å­˜åŠ è½½: 451 æ¡, 41 åˆ—
âœ“ æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡

5. ç¼“å­˜ä¿¡æ¯...
âœ“ ç¼“å­˜ç›®å½•: data/features
âœ“ ç¼“å­˜è‚¡ç¥¨æ•°: 1
âœ“ ç¼“å­˜å¤§å°: 0.15 MB

======================================================================
  æµ‹è¯•å®Œæˆï¼
======================================================================
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹æ˜¯å¦æœ‰ä¿å­˜å¤±è´¥çš„æ—¥å¿—ï¼š

```bash
# å¦‚æœä½¿ç”¨äº†æ—¥å¿—æ–‡ä»¶
grep "ä¿å­˜ç‰¹å¾ç¼“å­˜å¤±è´¥" logs/*.log

# æˆ–æŸ¥çœ‹æ ‡å‡†è¾“å‡º
```

### æ­¥éª¤4ï¼šæ‰‹åŠ¨éªŒè¯ä¸€ä¸ªæ–‡ä»¶

```python
import pandas as pd
from pathlib import Path

# æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
cache_dir = Path("data/features")
files = list(cache_dir.glob("*_features.parquet"))

print(f"ç‰¹å¾ç¼“å­˜æ–‡ä»¶æ•°é‡: {len(files)}")

if files:
    # è¯»å–ç¬¬ä¸€ä¸ªæ–‡ä»¶
    first_file = files[0]
    print(f"\næµ‹è¯•æ–‡ä»¶: {first_file}")
    print(f"æ–‡ä»¶å¤§å°: {first_file.stat().st_size / 1024 / 1024:.2f} MB")
    
    # å°è¯•è¯»å–
    df = pd.read_parquet(first_file)
    print(f"æ•°æ®: {len(df)} æ¡, {df.shape[1]} åˆ—")
else:
    print("æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰¹å¾ç¼“å­˜æ–‡ä»¶ï¼")
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šé‡æ–°è¿è¡Œæ•°æ®é¢„çƒ­

```bash
# æ¸…é™¤è¿›åº¦ï¼Œé‡æ–°å¼€å§‹
rm data/.progress_features.json

# é‡æ–°é¢„çƒ­ï¼ˆåªé¢„çƒ­ç‰¹å¾ï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --stock-type ä¸»æ¿ \
    --features-only \
    --workers 4 \
    --resume
```

### æ–¹æ¡ˆ2ï¼šæµ‹è¯•å•ä¸ªè‚¡ç¥¨

```bash
# æµ‹è¯•å•ä¸ªè‚¡ç¥¨çš„ç¼“å­˜åŠŸèƒ½
python test_feature_cache.py
```

å¦‚æœæµ‹è¯•æˆåŠŸï¼Œè¯´æ˜ä»£ç æ²¡é—®é¢˜ï¼Œå¯èƒ½æ˜¯æ‰¹é‡é¢„çƒ­æ—¶çš„é—®é¢˜ã€‚

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥æ•°æ®è´¨é‡

å¯èƒ½æ˜¯æ•°æ®è´¨é‡é—®é¢˜å¯¼è‡´ç‰¹å¾ä¸ºç©ºï¼š

```bash
# è¿è¡Œè°ƒè¯•è„šæœ¬
python debug_data.py
```

æŸ¥çœ‹æ˜¯å¦æœ‰"æ‰€æœ‰æ•°æ®éƒ½è¢«åˆ é™¤"çš„æç¤ºã€‚

### æ–¹æ¡ˆ4ï¼šä¿®æ”¹ä»£ç å¢åŠ è°ƒè¯•ä¿¡æ¯

åœ¨`process_single_feature`å‡½æ•°ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```python
def process_single_feature(args):
    symbol, start_date, end_date, kline_cache_dir, feature_cache_dir, index, total = args
    
    try:
        # ... åŠ è½½æ•°æ® ...
        
        # è®¡ç®—ç‰¹å¾
        df_features = builder.build_feature_matrix(df)
        
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        print(f"[DEBUG] {symbol}: ç‰¹å¾æ•°æ® {len(df_features)} æ¡")
        
        if df_features.empty:
            print(f"[DEBUG] {symbol}: ç‰¹å¾æ•°æ®ä¸ºç©ºï¼Œä¸ä¿å­˜ç¼“å­˜")
            return (symbol, False, 0, 0, "ç‰¹å¾æ•°æ®ä¸ºç©º")
        
        # ä¿å­˜ç‰¹å¾ç¼“å­˜
        feature_cache.save_features(symbol, df_features)
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»º
        cache_file = Path(feature_cache_dir) / f"{symbol}_features.parquet"
        if cache_file.exists():
            print(f"[DEBUG] {symbol}: ç¼“å­˜æ–‡ä»¶å·²åˆ›å»º")
        else:
            print(f"[DEBUG] {symbol}: ç¼“å­˜æ–‡ä»¶æœªåˆ›å»ºï¼")
        
        return (symbol, True, len(df_features), df_features.shape[1], None)
        
    except Exception as e:
        print(f"[DEBUG] {symbol}: å¼‚å¸¸ - {e}")
        return (symbol, False, 0, 0, str(e))
```

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ®ä½ çš„è¾“å‡º"æˆåŠŸ: 3043, å¤±è´¥: 0"ï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

**`get_cache_info`æ–¹æ³•åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸‹å¯èƒ½æœ‰å»¶è¿Ÿæˆ–ç¼“å­˜é—®é¢˜**

### éªŒè¯æ–¹æ³•

```bash
# ç›´æ¥æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
ls data/features/*.parquet | wc -l
du -sh data/features/
```

å¦‚æœè¿™é‡Œæ˜¾ç¤ºæœ‰æ–‡ä»¶å’Œå¤§å°ï¼Œè¯´æ˜ç¼“å­˜å®é™…ä¸Šæ˜¯æˆåŠŸçš„ï¼Œåªæ˜¯`get_cache_info`æ˜¾ç¤ºæœ‰é—®é¢˜ã€‚

---

## ğŸ“ æ€»ç»“

### å¿«é€Ÿæ£€æŸ¥

```bash
# 1. æ£€æŸ¥æ–‡ä»¶æ•°é‡
ls data/features/*.parquet | wc -l

# 2. æ£€æŸ¥ç¼“å­˜å¤§å°
du -sh data/features/

# 3. æµ‹è¯•å•ä¸ªè‚¡ç¥¨
python test_feature_cache.py
```

### å¦‚æœæ–‡ä»¶å­˜åœ¨

è¯´æ˜ç¼“å­˜æˆåŠŸäº†ï¼Œåªæ˜¯æ˜¾ç¤ºæœ‰é—®é¢˜ï¼Œå¯ä»¥å¿½ç•¥ã€‚

### å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨

è¯´æ˜ç¼“å­˜å¤±è´¥äº†ï¼Œéœ€è¦ï¼š
1. è¿è¡Œ`python test_feature_cache.py`æµ‹è¯•
2. æ£€æŸ¥æ•°æ®è´¨é‡
3. é‡æ–°è¿è¡Œé¢„çƒ­è„šæœ¬

ç°åœ¨è¯·è¿è¡Œæ£€æŸ¥å‘½ä»¤ï¼Œçœ‹çœ‹æ–‡ä»¶æ˜¯å¦å®é™…å­˜åœ¨ï¼
