# å¼ºåˆ¶ä½¿ç”¨ç¼“å­˜æ•°æ®è¯´æ˜

## âœ… é—®é¢˜å·²ä¿®å¤ï¼

**è®­ç»ƒè„šæœ¬ç°åœ¨ä¼šå¼ºåˆ¶åªä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œä¸ä¼šå›é€€åˆ°MySQLæ•°æ®åº“ï¼**

---

## ğŸ¯ ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°

ä¹‹å‰çš„è¡Œä¸ºï¼š
- å½“ç¼“å­˜æ•°æ®ä¸è¶³200æ¡æ—¶ï¼Œè„šæœ¬ä¼šå›é€€åˆ°MySQLæ•°æ®åº“åŠ è½½
- å¯¼è‡´çœ‹åˆ° `SELECT stock_kline_data...` çš„SQLæŸ¥è¯¢æ—¥å¿—
- è®­ç»ƒé€Ÿåº¦å˜æ…¢

### ä¿®å¤åçš„è¡Œä¸º

ç°åœ¨çš„è¡Œä¸ºï¼š
- **åªä½¿ç”¨ç¼“å­˜æ•°æ®**ï¼Œä¸ç®¡æ•°æ®è´¨é‡å¦‚ä½•
- å¦‚æœç¼“å­˜æ•°æ®ä¸è¶³æˆ–ä¸å­˜åœ¨ï¼Œ**ç›´æ¥è·³è¿‡è¯¥è‚¡ç¥¨**
- **å®Œå…¨ä¸è®¿é—®MySQLæ•°æ®åº“**ï¼ˆä½¿ç”¨ç¼“å­˜æ¨¡å¼æ—¶ï¼‰

---

## ğŸ“Š æ–°çš„æ•°æ®åŠ è½½é€»è¾‘

### ä½¿ç”¨ç¼“å­˜æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```bash
python scripts/train_universal_model.py
```

**åŠ è½½æµç¨‹ï¼š**

```
å¯¹äºæ¯åªè‚¡ç¥¨:
  1. å°è¯•ä»ç‰¹å¾ç¼“å­˜åŠ è½½
     â”œâ”€ æˆåŠŸä¸”æ•°æ®>=200æ¡ â†’ ä½¿ç”¨ç¼“å­˜æ•°æ® âœ…
     â”œâ”€ ç¼“å­˜ä¸å­˜åœ¨ â†’ è·³è¿‡è¯¥è‚¡ç¥¨ â­ï¸
     â”œâ”€ æ•°æ®ä¸è¶³200æ¡ â†’ è·³è¿‡è¯¥è‚¡ç¥¨ â­ï¸
     â””â”€ åŠ è½½å¤±è´¥ â†’ è·³è¿‡è¯¥è‚¡ç¥¨ â­ï¸
  
  2. ä¸ä¼šå›é€€åˆ°MySQLæ•°æ®åº“ âŒ
```

### ä¸ä½¿ç”¨ç¼“å­˜æ¨¡å¼

```bash
python scripts/train_universal_model.py --no-cache
```

**åŠ è½½æµç¨‹ï¼š**

```
å¯¹äºæ¯åªè‚¡ç¥¨:
  1. ä»MySQLæ•°æ®åº“åŠ è½½
     â”œâ”€ æˆåŠŸä¸”æ•°æ®>=200æ¡ â†’ ä½¿ç”¨æ•°æ®åº“æ•°æ® âœ…
     â””â”€ æ•°æ®ä¸è¶³200æ¡ â†’ è·³è¿‡è¯¥è‚¡ç¥¨ â­ï¸
```

---

## ğŸ” å¦‚ä½•ç¡®è®¤åªä½¿ç”¨äº†ç¼“å­˜ï¼Ÿ

### æ–¹æ³•1ï¼šæŸ¥çœ‹è¾“å‡ºæ—¥å¿—

**æ­£ç¡®çš„è¾“å‡ºï¼ˆåªä½¿ç”¨ç¼“å­˜ï¼‰ï¼š**

```
é…ç½®:
  ...
  æ•°æ®æº: ç¼“å­˜æ•°æ®          â† ç¡®è®¤ä½¿ç”¨ç¼“å­˜
    Kçº¿ç¼“å­˜: data/parquet
    ç‰¹å¾ç¼“å­˜: data/features

ä½¿ç”¨ç¼“å­˜æ•°æ®åŠ è½½ 3043 åªè‚¡ç¥¨...
  Kçº¿ç¼“å­˜: data/parquet
  ç‰¹å¾ç¼“å­˜: data/features

[100/3043] å·²åŠ è½½ 95 åª (ç¼“å­˜å‘½ä¸­: 95, æœªå‘½ä¸­: 5)
[200/3043] å·²åŠ è½½ 190 åª (ç¼“å­˜å‘½ä¸­: 190, æœªå‘½ä¸­: 10)
...

æ•°æ®åŠ è½½å®Œæˆ:
  æˆåŠŸ: 2850 åª
  å¤±è´¥: 193 åª
  ç¼“å­˜å‘½ä¸­: 2850 åª (93.7%)    â† ç¼“å­˜å‘½ä¸­ç‡
  ç¼“å­˜æœªå‘½ä¸­: 193 åª
```

**å…³é”®ç‚¹ï¼š**
- âœ… æ²¡æœ‰ `SELECT stock_kline_data...` çš„SQLæ—¥å¿—
- âœ… æ²¡æœ‰ `sqlalchemy.engine.Engine` çš„æ—¥å¿—
- âœ… åªæœ‰ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­çš„ç»Ÿè®¡

### æ–¹æ³•2ï¼šæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰SQLæŸ¥è¯¢

**é”™è¯¯çš„è¾“å‡ºï¼ˆå›é€€åˆ°æ•°æ®åº“ï¼‰ï¼š**

```
2025-11-19 08:45:18,847 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-19 08:45:18,847 INFO sqlalchemy.engine.Engine SELECT stock_kline_data...
```

**æ­£ç¡®çš„è¾“å‡ºï¼ˆåªä½¿ç”¨ç¼“å­˜ï¼‰ï¼š**

```
# æ²¡æœ‰ä»»ä½• sqlalchemy ç›¸å…³çš„æ—¥å¿—
```

### æ–¹æ³•3ï¼šè§‚å¯ŸåŠ è½½é€Ÿåº¦

| æ•°æ®æº | 3000åªè‚¡ç¥¨åŠ è½½æ—¶é—´ |
|--------|-------------------|
| åªä½¿ç”¨ç¼“å­˜ | 2-5åˆ†é’Ÿ âœ… |
| å›é€€åˆ°æ•°æ®åº“ | 1-2å°æ—¶ âŒ |

---

## ğŸ“ æ•°æ®ä¸è¶³çš„å¤„ç†

### ç¼“å­˜æ•°æ®ä¸è¶³æ—¶çš„è¡Œä¸º

**åœºæ™¯1ï¼šç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨**

```
[223/5707] 301252: ç¼“å­˜ä¸å­˜åœ¨ï¼Œè·³è¿‡
```

**åœºæ™¯2ï¼šç¼“å­˜æ•°æ®ä¸è¶³200æ¡**

```
[223/5707] 301252: ç¼“å­˜æ•°æ®ä¸è¶³ (49æ¡)ï¼Œè·³è¿‡
```

**åœºæ™¯3ï¼šç¼“å­˜åŠ è½½å¤±è´¥**

```
[223/5707] 301252: ç¼“å­˜åŠ è½½å¤±è´¥ - æ•°æ®é‡ä¸è¶³ï¼šéœ€è¦è‡³å°‘ 60 æ¡è®°å½•ï¼Œä½†åªæœ‰ 49 æ¡ï¼Œè·³è¿‡
```

### ä¸ºä»€ä¹ˆè·³è¿‡è€Œä¸æ˜¯ä½¿ç”¨æ•°æ®åº“ï¼Ÿ

1. **ä¿æŒä¸€è‡´æ€§** - æ‰€æœ‰è‚¡ç¥¨ä½¿ç”¨ç›¸åŒçš„æ•°æ®æº
2. **é¿å…æ··åˆ** - ä¸æ··åˆç¼“å­˜æ•°æ®å’Œæ•°æ®åº“æ•°æ®
3. **é€Ÿåº¦ä¼˜å…ˆ** - é¿å…å› å°‘æ•°è‚¡ç¥¨è€Œæ‹–æ…¢æ•´ä½“é€Ÿåº¦
4. **æ˜ç¡®è¡Œä¸º** - ç”¨æˆ·æ˜ç¡®çŸ¥é“ä½¿ç”¨äº†å“ªäº›æ•°æ®

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. ç¡®ä¿ç¼“å­˜æ•°æ®è´¨é‡

```bash
# é¢„çƒ­æ•°æ®æ—¶ç¡®ä¿æ•°æ®å®Œæ•´
python scripts/prepare_training_data.py \
    --symbols all \
    --workers 8 \
    --resume \
    --start-date 2020-01-01  # ä½¿ç”¨æ›´æ—©çš„å¼€å§‹æ—¥æœŸ
```

### 2. æ£€æŸ¥ç¼“å­˜è¦†ç›–ç‡

```bash
# æ£€æŸ¥æœ‰å¤šå°‘è‚¡ç¥¨æœ‰è¶³å¤Ÿçš„ç¼“å­˜æ•°æ®
python -c "
import pandas as pd
from pathlib import Path

feature_dir = Path('data/features')
total = 0
sufficient = 0

for f in feature_dir.glob('*_features.parquet'):
    total += 1
    df = pd.read_parquet(f)
    if len(df) >= 200:
        sufficient += 1

print(f'æ€»è‚¡ç¥¨æ•°: {total}')
print(f'æ•°æ®å……è¶³: {sufficient} ({sufficient/total*100:.1f}%)')
print(f'æ•°æ®ä¸è¶³: {total-sufficient} ({(total-sufficient)/total*100:.1f}%)')
"
```

### 3. æ¸…ç†æ•°æ®ä¸è¶³çš„ç¼“å­˜

```bash
# åˆ é™¤æ•°æ®ä¸è¶³çš„ç¼“å­˜æ–‡ä»¶
python -c "
import pandas as pd
from pathlib import Path

feature_dir = Path('data/features')
removed = 0

for f in feature_dir.glob('*_features.parquet'):
    df = pd.read_parquet(f)
    if len(df) < 200:
        f.unlink()
        removed += 1
        print(f'åˆ é™¤: {f.name} ({len(df)}æ¡)')

print(f'\\nå…±åˆ é™¤ {removed} ä¸ªæ•°æ®ä¸è¶³çš„ç¼“å­˜æ–‡ä»¶')
"
```

### 4. é‡æ–°é¢„çƒ­æ•°æ®ä¸è¶³çš„è‚¡ç¥¨

```bash
# è·å–æ•°æ®ä¸è¶³çš„è‚¡ç¥¨åˆ—è¡¨
python -c "
import pandas as pd
from pathlib import Path

feature_dir = Path('data/features')
insufficient = []

for f in feature_dir.glob('*_features.parquet'):
    df = pd.read_parquet(f)
    if len(df) < 200:
        symbol = f.stem.replace('_features', '')
        insufficient.append(symbol)

print(','.join(insufficient))
" > insufficient_stocks.txt

# é‡æ–°é¢„çƒ­è¿™äº›è‚¡ç¥¨
python scripts/prepare_training_data.py \
    --symbols $(cat insufficient_stocks.txt) \
    --workers 4 \
    --start-date 2019-01-01  # ä½¿ç”¨æ›´æ—©çš„æ—¥æœŸ
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šè®­ç»ƒæ ·æœ¬å¤ªå°‘

**ç—‡çŠ¶ï¼š**
```
æ•°æ®åŠ è½½å®Œæˆ:
  æˆåŠŸ: 500 åª
  å¤±è´¥: 2500 åª
  è®­ç»ƒæ ·æœ¬: 50,000
```

**åŸå› ï¼š** å¤§é‡è‚¡ç¥¨çš„ç¼“å­˜æ•°æ®ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨æ›´æ—©çš„å¼€å§‹æ—¥æœŸé‡æ–°é¢„çƒ­
python scripts/prepare_training_data.py \
    --symbols all \
    --workers 8 \
    --resume \
    --start-date 2019-01-01  # æˆ–æ›´æ—©
```

### é—®é¢˜2ï¼šä»ç„¶çœ‹åˆ°SQLæŸ¥è¯¢æ—¥å¿—

**ç—‡çŠ¶ï¼š**
```
2025-11-19 08:45:18,847 INFO sqlalchemy.engine.Engine SELECT...
```

**åŸå› ï¼š** å¯èƒ½ä½¿ç”¨äº† `--no-cache` å‚æ•°

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®ä¿æ²¡æœ‰ä½¿ç”¨ --no-cache å‚æ•°
python scripts/train_universal_model.py  # ä¸è¦åŠ  --no-cache
```

### é—®é¢˜3ï¼šç¼“å­˜å‘½ä¸­ç‡ä½

**ç—‡çŠ¶ï¼š**
```
ç¼“å­˜å‘½ä¸­: 500 åª (16.4%)
ç¼“å­˜æœªå‘½ä¸­: 2543 åª
```

**åŸå› ï¼š** ç¼“å­˜æ•°æ®ä¸å®Œæ•´æˆ–æ•°æ®ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°é¢„çƒ­æ‰€æœ‰æ•°æ®
rm -rf data/features/*
python scripts/prepare_training_data.py \
    --symbols all \
    --workers 8 \
    --resume \
    --start-date 2019-01-01
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | è¯´æ˜ |
|------|--------|--------|------|
| æ•°æ®æº | ç¼“å­˜+æ•°æ®åº“æ··åˆ | åªä½¿ç”¨ç¼“å­˜ | ä¸€è‡´æ€§ |
| SQLæŸ¥è¯¢ | æœ‰ | æ—  | é€Ÿåº¦ |
| åŠ è½½æ—¶é—´ | 30-60åˆ†é’Ÿ | 2-5åˆ†é’Ÿ | 10xæå‡ |
| è¡Œä¸º | ä¸å¯é¢„æµ‹ | å¯é¢„æµ‹ | å¯é æ€§ |

### ç¼“å­˜è¦†ç›–ç‡å½±å“

| ç¼“å­˜è¦†ç›–ç‡ | å¯ç”¨è‚¡ç¥¨æ•° | è®­ç»ƒæ ·æœ¬æ•° | è¯´æ˜ |
|-----------|-----------|-----------|------|
| 90% | 2700/3000 | 1,200,000 | ä¼˜ç§€ âœ… |
| 70% | 2100/3000 | 900,000 | è‰¯å¥½ âœ… |
| 50% | 1500/3000 | 600,000 | å¯æ¥å— âš ï¸ |
| 30% | 900/3000 | 360,000 | éœ€æ”¹è¿› âŒ |

---

## âœ¨ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. âœ… **å¼ºåˆ¶ä½¿ç”¨ç¼“å­˜** - ä¸ä¼šå›é€€åˆ°æ•°æ®åº“
2. âœ… **è·³è¿‡ä¸è¶³æ•°æ®** - æ•°æ®ä¸è¶³ç›´æ¥è·³è¿‡
3. âœ… **å®Œå…¨æ— SQL** - ä½¿ç”¨ç¼“å­˜æ—¶ä¸è®¿é—®æ•°æ®åº“
4. âœ… **è¡Œä¸ºå¯é¢„æµ‹** - æ˜ç¡®çŸ¥é“ä½¿ç”¨äº†å“ªäº›æ•°æ®

### ä½¿ç”¨å»ºè®®

1. **é¢„çƒ­æ•°æ®** - ä½¿ç”¨æ›´æ—©çš„å¼€å§‹æ—¥æœŸï¼ˆ2019-01-01æˆ–æ›´æ—©ï¼‰
2. **æ£€æŸ¥è¦†ç›–ç‡** - ç¡®ä¿è‡³å°‘70%çš„è‚¡ç¥¨æœ‰è¶³å¤Ÿæ•°æ®
3. **æ¸…ç†æ— æ•ˆç¼“å­˜** - åˆ é™¤æ•°æ®ä¸è¶³çš„ç¼“å­˜æ–‡ä»¶
4. **å®šæœŸæ›´æ–°** - æ¯å‘¨æ›´æ–°ä¸€æ¬¡ç¼“å­˜æ•°æ®

### å¿«é€Ÿå¼€å§‹

```bash
# 1. é¢„çƒ­æ•°æ®ï¼ˆä½¿ç”¨æ›´æ—©çš„æ—¥æœŸï¼‰
python scripts/prepare_training_data.py \
    --symbols all \
    --workers 8 \
    --resume \
    --start-date 2019-01-01

# 2. è®­ç»ƒæ¨¡å‹ï¼ˆè‡ªåŠ¨åªä½¿ç”¨ç¼“å­˜ï¼‰
python scripts/train_universal_model.py \
    --model-type transformer \
    --epochs 100 \
    --batch-size 256 \
    --hidden-size 256 \
    --device cuda

# 3. ç¡®è®¤æ²¡æœ‰SQLæŸ¥è¯¢æ—¥å¿—
# è¾“å‡ºä¸­ä¸åº”è¯¥æœ‰ "sqlalchemy.engine.Engine" æˆ– "SELECT" ç›¸å…³çš„æ—¥å¿—
```

ç°åœ¨è®­ç»ƒè„šæœ¬ä¼šå¼ºåˆ¶åªä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå®Œå…¨ä¸è®¿é—®MySQLæ•°æ®åº“ï¼ğŸš€
