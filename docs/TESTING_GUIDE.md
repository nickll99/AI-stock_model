# 测试指南

## 概述

本文档说明如何测试A股AI模型系统的训练和预测功能。

## 测试脚本

### 1. 快速测试 (quick_test.py)

快速检查系统各模块是否正常工作。

**测试内容：**
- ✓ 模块导入检查
- ✓ 数据库连接测试
- ✓ 模型创建测试
- ✓ 特征工程测试

**运行方法：**
```bash
python quick_test.py
```

**预期输出：**
```
============================================================
  A股AI模型系统 - 快速测试
============================================================

============================================================
  测试模块导入
============================================================
✓ 数据加载           - src.data.loader
✓ 数据验证           - src.data.validator
...

============================================================
  测试数据库连接
============================================================
✓ 数据库连接成功
✓ 股票基本信息表记录数: 5000
✓ 活跃股票数量: 4800

...

总计: 4/4 测试通过
✓ 所有测试通过！系统准备就绪。
```

### 2. 完整端到端测试 (test_training_prediction.py)

完整测试从数据加载到模型训练再到预测的整个流程。

**测试内容：**
1. ✓ 数据加载和验证
2. ✓ 特征工程（技术指标计算）
3. ✓ 数据集构建和划分
4. ✓ 模型训练（LSTM/GRU/Transformer）
5. ✓ 模型评估
6. ✓ 价格预测
7. ✓ 置信区间预测

**运行方法：**
```bash
python test_training_prediction.py
```

**预期输出：**
```
======================================================================
  A股AI模型系统 - 端到端测试
  测试：数据加载 → 特征工程 → 模型训练 → 预测
======================================================================

======================================================================
  测试1: 数据加载
======================================================================

获取活跃股票列表...
✓ 活跃股票数量: 4800
✓ 测试股票: 000001

获取股票 000001 的基本信息...
✓ 股票名称: 平安银行
✓ 所属行业: 银行
✓ 上市日期: 1991-04-03

...

======================================================================
  测试4: 模型训练 (LSTM)
======================================================================

创建LSTM模型...
✓ 输入特征数: 45
✓ 模型参数数量: 123,456

开始训练（测试模式：5个epoch）...
Epoch [1/5] - Train Loss: 0.012345, Val Loss: 0.013456, Time: 12.34s
...

✓ 训练完成
✓ 最终训练损失: 0.008765
✓ 最终验证损失: 0.009876
✓ 最佳验证损失: 0.009123

...

======================================================================
  测试6: 预测功能
======================================================================

生成未来5天的价格预测...

✓ 预测结果:
  股票代码: 000001
  基准日期: 2024-12-31
  基准价格: 15.23
  趋势判断: upward

  未来5天预测:
    2025-01-01: 15.35 (+0.79%)
    2025-01-02: 15.42 (+1.25%)
    2025-01-03: 15.48 (+1.64%)
    2025-01-04: 15.51 (+1.84%)
    2025-01-05: 15.55 (+2.10%)

...

======================================================================
  测试总结
======================================================================

✓ 所有核心功能测试完成！
```

## 测试前准备

### 1. 环境配置

确保已安装所有依赖：

```bash
pip install -r requirements.txt
```

### 2. 数据库配置

确保MySQL数据库已启动并配置正确：

**检查 .env 文件：**
```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=stock_db
```

**验证数据库：**
```bash
mysql -u root -p
```

```sql
USE stock_db;
SELECT COUNT(*) FROM stock_basic_info;
SELECT COUNT(*) FROM stock_kline_data;
```

### 3. 数据准备

确保数据库中有足够的数据：

- `stock_basic_info` 表：至少有活跃股票记录
- `stock_kline_data` 表：至少有3年的日线数据

## 测试场景

### 场景1：快速验证系统可用性

```bash
# 运行快速测试
python quick_test.py
```

**适用于：**
- 首次部署后验证
- 代码更新后快速检查
- 排查环境问题

### 场景2：完整功能测试

```bash
# 运行完整测试（约需5-10分钟）
python test_training_prediction.py
```

**适用于：**
- 验证训练流程
- 测试预测功能
- 评估模型性能

### 场景3：测试特定模型

修改 `test_training_prediction.py` 中的模型类型：

```python
# 在 main() 函数中修改
model_type = 'gru'  # 或 'transformer'
```

### 场景4：调整训练参数

修改训练参数进行实验：

```python
# 在 test_model_training() 函数中修改
history = trainer.train(
    train_loader=train_loader,
    val_loader=val_loader,
    epochs=50,  # 增加epoch数
    learning_rate=0.001,
    patience=10,
    checkpoint_interval=10
)
```

## 常见问题

### Q1: 数据库连接失败

**错误信息：**
```
✗ 数据库连接失败: (2003, "Can't connect to MySQL server...")
```

**解决方法：**
1. 检查MySQL服务是否启动
2. 验证 .env 文件中的数据库配置
3. 确认数据库用户权限

### Q2: 数据不足

**错误信息：**
```
✗ 数据不足，需要至少 60 条记录
```

**解决方法：**
1. 检查数据库中是否有足够的历史数据
2. 选择有更多数据的股票进行测试
3. 减少 seq_length 参数（不推荐）

### Q3: 内存不足

**错误信息：**
```
RuntimeError: CUDA out of memory
```

**解决方法：**
1. 减小 batch_size
2. 减小模型大小（hidden_size, num_layers）
3. 使用CPU训练（自动降级）

### Q4: 模型训练很慢

**原因：**
- CPU训练比GPU慢很多
- 数据量大
- 模型复杂

**解决方法：**
1. 使用GPU（如果可用）
2. 减少训练数据量（用于测试）
3. 减少epoch数（用于测试）
4. 使用更小的模型

### Q5: 预测结果不准确

**原因：**
- 测试脚本只训练5个epoch（用于快速验证）
- 模型未充分训练

**解决方法：**
1. 增加训练epoch数（建议50-100）
2. 调优超参数
3. 使用更多训练数据
4. 尝试不同的模型类型

## 性能基准

### 训练性能

**硬件配置：**
- CPU: Intel i7-10700K
- GPU: NVIDIA RTX 3080
- RAM: 32GB

**训练时间（50 epochs）：**
- LSTM: ~15分钟
- GRU: ~12分钟
- Transformer: ~20分钟

### 预测性能

**单次预测：**
- 简单预测: <1秒
- 置信区间预测: 2-5秒（取决于采样次数）

**批量预测（100只股票）：**
- 简单预测: ~30秒
- 置信区间预测: ~3分钟

## 评估指标说明

### MAE (Mean Absolute Error)
平均绝对误差，越小越好。

### RMSE (Root Mean Square Error)
均方根误差，越小越好。

### MAPE (Mean Absolute Percentage Error)
平均绝对百分比误差，越小越好。
- <10%: 优秀
- 10-20%: 良好
- 20-50%: 一般
- >50%: 较差

### R² (R-squared)
决定系数，越接近1越好。
- >0.9: 优秀
- 0.7-0.9: 良好
- 0.5-0.7: 一般
- <0.5: 较差

### 方向准确率
预测涨跌方向的准确率。
- >60%: 优秀
- 50-60%: 良好
- <50%: 需要改进

## 下一步

测试通过后，可以：

1. **完整训练模型**
   ```bash
   # 修改epoch数为50-100
   python test_training_prediction.py
   ```

2. **测试其他模型**
   - GRU模型
   - Transformer模型

3. **调优超参数**
   - 学习率
   - 隐藏层大小
   - 层数
   - Dropout率

4. **集成到API**
   - 启动FastAPI服务
   - 测试API端点
   - 前端集成

5. **部署**
   - Docker容器化
   - 生产环境部署

## 相关文档

- [API文档](API_DOCUMENTATION.md)
- [部署指南](DEPLOYMENT_GUIDE.md)
- [开发指南](DEVELOPMENT_GUIDE.md)
